<!DOCTYPE html>
<html lang="ja">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>Codex Word Master</title>
    <style>
        :root {
            --bg-color: #0f172a;
            --card-bg: #1e293b;
            --accent: #38bdf8;
            --correct: #22c55e;
            --wrong: #ef4444;
            --text: #f8fafc;
            --text-muted: #94a3b8;
        }

        * {
            box-sizing: border-box;
            margin: 0;
            padding: 0;
            -webkit-tap-highlight-color: transparent;
            user-select: none;
        }

        body {
            font-family: 'Helvetica Neue', Arial, sans-serif;
            background-color: var(--bg-color);
            color: var(--text);
            overflow: hidden;
            width: 100vw;
            height: 100vh;
            display: flex;
            justify-content: center;
        }

        #app {
            width: 100%;
            max-width: 500px;
            height: 100%;
            position: relative;
            display: flex;
            flex-direction: column;
            padding: 20px;
        }

        h1 { font-size: 1.8rem; text-align: center; margin-bottom: 1rem; color: var(--accent); }
        .screen { display: none; flex-direction: column; height: 100%; }
        .screen.active { display: flex; }
        .screen-fade { animation: fadeIn 0.3s ease-out; }
        @keyframes fadeIn { from { opacity: 0; transform: translateY(10px); } to { opacity: 1; transform: translateY(0); } }

        button {
            background-color: var(--card-bg);
            border: 2px solid var(--accent);
            color: var(--text);
            padding: 16px;
            border-radius: 12px;
            font-size: 1.1rem;
            font-weight: bold;
            cursor: pointer;
            transition: all 0.2s;
            margin-bottom: 12px;
            width: 100%;
            display: flex;
            justify-content: center;
            align-items: center;
            min-height: 60px;
        }
        button:active { transform: scale(0.98); background-color: var(--accent); color: var(--bg-color); }
        button.secondary { border-color: var(--text-muted); color: var(--text-muted); }

        .title-screen, .init-screen, .countdown-screen { justify-content: center; text-align: center; }
        .countdown-number { font-size: 8rem; font-weight: bold; color: var(--accent); animation: pulse 1s infinite; }
        @keyframes pulse { 0% { transform: scale(1); } 50% { transform: scale(1.1); } 100% { transform: scale(1); } }

        .select-group { margin-bottom: 2rem; }
        .select-label { font-size: 0.9rem; color: var(--text-muted); margin-bottom: 0.5rem; }

        .game-header { display: flex; justify-content: space-between; align-items: center; margin-bottom: 1rem; }
        .timer { font-size: 1.5rem; font-weight: bold; font-variant-numeric: tabular-nums; }
        .timer.low { color: var(--wrong); }
        .score-display { font-size: 1.2rem; color: var(--accent); }

        .question-card {
            background: var(--card-bg);
            padding: 40px 20px;
            border-radius: 20px;
            text-align: center;
            margin-bottom: 2rem;
            box-shadow: 0 10px 25px -5px rgba(0,0,0,0.3);
        }
        .question-jp { font-size: 2rem; font-weight: bold; margin-bottom: 0.5rem; }
        .question-hint { color: var(--text-muted); font-size: 1rem; }

        .typing-input {
            background: var(--card-bg);
            border: 2px solid var(--accent);
            border-radius: 12px;
            padding: 16px;
            font-size: 1.5rem;
            color: var(--text);
            text-align: center;
            outline: none;
            width: 100%;
        }

        .card-area { display: flex; flex-direction: column; gap: 1rem; }
        .answer-slots { display: flex; flex-wrap: wrap; justify-content: center; gap: 8px; min-height: 50px; border-bottom: 2px solid var(--accent); padding-bottom: 8px; }
        .choice-pool { display: flex; flex-wrap: wrap; justify-content: center; gap: 8px; margin-top: 1rem; }
        .char-card {
            background: var(--accent);
            color: var(--bg-color);
            width: 45px;
            height: 45px;
            display: flex;
            justify-content: center;
            align-items: center;
            border-radius: 8px;
            font-size: 1.2rem;
            font-weight: bold;
            box-shadow: 0 4px 0 #075985;
        }
        .char-card.used { opacity: 0.2; pointer-events: none; background: #475569; box-shadow: none; transform: translateY(2px); }

        .feedback {
            position: fixed;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            font-size: 8rem;
            pointer-events: none;
            z-index: 100;
            opacity: 0;
        }
        .feedback.show { animation: popFeedback 0.4s ease-out; }
        @keyframes popFeedback { 
            0% { opacity: 0; transform: translate(-50%, -50%) scale(0.5); }
            50% { opacity: 1; transform: translate(-50%, -50%) scale(1.2); }
            100% { opacity: 0; transform: translate(-50%, -50%) scale(1); }
        }

        .result-list { flex-grow: 1; overflow-y: auto; margin: 1rem 0; padding-right: 5px; border-radius: 12px; background: rgba(30, 41, 59, 0.5); }
        .result-item { display: flex; justify-content: space-between; align-items: center; padding: 12px; border-bottom: 1px solid #334155; gap: 10px; }

        .setting-item { margin-bottom: 1.5rem; }
        .setting-item label { display: block; margin-bottom: 0.5rem; color: var(--text-muted); }
        input[type="text"] { width: 100%; padding: 12px; border-radius: 8px; border: 1px solid var(--text-muted); background: var(--bg-color); color: var(--text); font-size: 1.1rem; outline: none; }
        input[type="text"]:focus { border-color: var(--accent); }

        .modal-overlay {
            position: fixed;
            top: 0; left: 0; width: 100%; height: 100%;
            background: rgba(0,0,0,0.8);
            display: none;
            justify-content: center;
            align-items: center;
            z-index: 1000;
        }
        .modal {
            background: var(--card-bg);
            padding: 24px;
            border-radius: 16px;
            width: 80%;
            max-width: 320px;
            text-align: center;
        }

        .my-stats-card { background: var(--card-bg); padding: 15px; border-radius: 12px; margin-bottom: 20px; border: 1px solid var(--accent); }
        .stat-row { display: flex; justify-content: space-between; margin-bottom: 5px; font-size: 0.9rem; }
        .stat-val { font-weight: bold; color: var(--accent); }
    </style>
</head>
<body>

    <div id="app"></div>
    <div id="feedback" class="feedback"></div>
    <div id="modal-overlay" class="modal-overlay">
        <div class="modal">
            <p id="modal-text" style="margin-bottom: 20px; line-height: 1.5;"></p>
            <div id="modal-buttons" style="display: flex; gap: 10px;"></div>
        </div>
    </div>

    <script type="module">
        import { grade1Words } from "./data/grade1.js";
        import { grade2Words } from "./data/grade2.js";
        import { grade3Words } from "./data/grade3.js";
        const WORDS = grade1Words;

        function getWordsByGrade() {
            if (state.grade === "grade1") return grade1Words;
            if (state.grade === "grade2") return grade2Words;
            if (state.grade === "grade3") return grade3Words;
            return [];
        }

        function getUnits() {
            return [...new Set(getWordsByGrade().map(w => w.unit))];
        }

        const state = {
            screen: "init",
            lastRenderedScreen: null,
            mode: "typing",
            grade: "grade1",
            unit: "Unit1",
            timeLeft: 40,
            score: 0,
            correctCount: 0,
            wrongWords: [],
            currentWord: null,
            lastCorrectEn: null,
            nickname: localStorage.getItem('nickname') || "",
            soundOn: localStorage.getItem('soundOn') !== 'false',
            timerId: null,
            questionStartTime: 0,
            cardAnswer: [],
            currentChoices: [],
            countdownValue: 3,
            userStats: JSON.parse(localStorage.getItem('userStats')) || {
                cumulativeTotal: 0,
                unitBests: {}
            }
        };

        console.log("WORDS.length", WORDS.length);
        console.log("UNITS", getUnits());
        const $ = (id) => document.getElementById(id);

        // --- Core Functions ---

        function saveSettings() {
            localStorage.setItem('nickname', state.nickname);
            localStorage.setItem('soundOn', state.soundOn);
        }

        function updateRecords(sessionScore) {
            state.userStats.cumulativeTotal += sessionScore;
            const currentBest = state.userStats.unitBests[state.unit] || 0;
            if (sessionScore > currentBest) {
                state.userStats.unitBests[state.unit] = sessionScore;
            }
            localStorage.setItem('userStats', JSON.stringify(state.userStats));
        }

        function showModal(text, buttons = []) {
            const overlay = $('modal-overlay');
            const txt = $('modal-text');
            const btns = $('modal-buttons');
            txt.innerText = text;
            btns.innerHTML = '';
            if (buttons.length === 0) buttons = [{ text: 'OK', onClick: () => overlay.style.display = 'none' }];
            buttons.forEach(b => {
                const btn = document.createElement('button');
                btn.innerText = b.text;
                btn.className = b.type === 'danger' ? 'secondary' : '';
                btn.onclick = () => { overlay.style.display = 'none'; if (b.onClick) b.onClick(); };
                btns.appendChild(btn);
            });
            overlay.style.display = 'flex';
        }

        function playSound(isCorrect) {
            if (!state.soundOn) return;
            const ctx = new (window.AudioContext || window.webkitAudioContext)();
            const osc = ctx.createOscillator();
            const gain = ctx.createGain();
            osc.connect(gain); gain.connect(ctx.destination);
            if (isCorrect) {
                osc.type = 'sine'; osc.frequency.setValueAtTime(880, ctx.currentTime);
                osc.frequency.exponentialRampToValueAtTime(1320, ctx.currentTime + 0.1);
            } else {
                osc.type = 'square'; osc.frequency.setValueAtTime(220, ctx.currentTime);
                osc.frequency.linearRampToValueAtTime(110, ctx.currentTime + 0.2);
            }
            gain.gain.setValueAtTime(0.1, ctx.currentTime);
            gain.gain.exponentialRampToValueAtTime(0.01, ctx.currentTime + 0.2);
            osc.start(); osc.stop(ctx.currentTime + 0.2);
        }

        function speakWord(word) {
            if (!state.soundOn) return;
            const uttr = new SpeechSynthesisUtterance(word);
            uttr.lang = 'en-US';
            const voices = speechSynthesis.getVoices();
            const preferredVoice = voices.find(v => (v.lang === 'en-US' || v.lang === 'en_US') && (v.name.includes('Google') || v.name.includes('Premium'))) || 
                                  voices.find(v => v.lang === 'en-US' || v.lang === 'en_US');
            if (preferredVoice) uttr.voice = preferredVoice;
            uttr.rate = 0.9;
            speechSynthesis.speak(uttr);
        }

        function triggerFeedback(isCorrect) {
            const el = $('feedback');
            el.innerText = isCorrect ? '‚óØ' : '√ó';
            el.style.color = isCorrect ? 'var(--correct)' : 'var(--wrong)';
            el.classList.remove('show'); void el.offsetWidth; el.classList.add('show');
            playSound(isCorrect);
        }

        function calcScore(elapsedMs) {
            if (elapsedMs <= 1000) return 100;
            return Math.max(0, 100 - Math.floor((elapsedMs - 1000) / 750) * 4);
        }

        function pickQuestion() {
            const pool = getWordsByGrade().filter(w => w.unit === state.unit);
            let candidates = pool.filter(w => w.en !== state.lastCorrectEn);
            if (candidates.length === 0) candidates = pool;
            const next = candidates[Math.floor(Math.random() * candidates.length)];
            state.currentWord = next;
            state.questionStartTime = Date.now();
            state.cardAnswer = [];
            if (state.mode === 'card') {
                state.currentChoices = shuffleArray(next.en.split('')).map((char, index) => ({ id: index, char, used: false }));
            }
            render();
            if (state.mode === 'typing') {
                setTimeout(() => { const input = document.querySelector('.typing-input'); if (input) input.focus(); }, 50);
            }
        }

        function handleAnswer(answer) {
            const elapsed = Date.now() - state.questionStartTime;
            const isCorrect = answer === state.currentWord.en;
            if (isCorrect) {
                state.score += calcScore(elapsed); state.correctCount++;
                state.lastCorrectEn = state.currentWord.en;
                speakWord(state.currentWord.en);
            } else {
                state.wrongWords.push({ jp: state.currentWord.jp, en: state.currentWord.en });
            }
            triggerFeedback(isCorrect); pickQuestion();
        }

        function startCountdown() {
            state.screen = "countdown";
            state.countdownValue = 3;
            render();
            const interval = setInterval(() => {
                state.countdownValue--;
                if (state.countdownValue <= 0) {
                    clearInterval(interval);
                    state.screen = "game";
                    state.score = 0; state.correctCount = 0; state.wrongWords = []; state.lastCorrectEn = null;
                    startTimer(); pickQuestion();
                } else {
                    render();
                }
            }, 1000);
        }

        function startTimer() {
            state.timeLeft = 60;
            state.timerId = setInterval(() => {
                state.timeLeft--;
                const timerEl = document.querySelector('.timer');
                if (timerEl) {
                    timerEl.innerText = state.timeLeft;
                    if (state.timeLeft <= 10) timerEl.classList.add('low');
                }
                if (state.timeLeft <= 0) endGame();
            }, 1000);
        }

        function endGame() {
            clearInterval(state.timerId);
            state.screen = "result";
            updateRecords(state.score);
            render();
        }

        function render() {
            const container = $('app');
            const isNewScreen = state.screen !== state.lastRenderedScreen;
            container.innerHTML = '';
            const screenDiv = document.createElement('div');
            screenDiv.className = `screen active ${state.screen}-screen ${isNewScreen ? 'screen-fade' : ''}`;
            state.lastRenderedScreen = state.screen;
            switch (state.screen) {
                case "init": renderInit(screenDiv); break;
                case "title": renderTitle(screenDiv); break;
                case "grade": renderGrade(screenDiv); break;
                case "select": renderSelect(screenDiv); break;
                case "countdown": renderCountdown(screenDiv); break;
                case "game": renderGame(screenDiv); break;
                case "result": renderResult(screenDiv); break;
                case "ranking": renderRanking(screenDiv); break;
                case "settings": renderSettings(screenDiv); break;
            }
            container.appendChild(screenDiv);
        }

        function renderInit(el) {
            el.innerHTML = `
                <h1>Welcome</h1>
                <div class="setting-item">
                    <label>„Éã„ÉÉ„ÇØ„Éç„Éº„É†„ÇíÂÖ•Âäõ„Åó„Å¶„Åè„Å†„Åï„ÅÑ</label>
                    <input type="text" id="init-nick" value="${state.nickname}" placeholder="ÂêçÂâç„ÇíÂÖ•Âäõ..." autofocus>
                </div>
                <button id="btn-init-start">„ÅØ„Åò„ÇÅ„Çã</button>
            `;
            el.querySelector('#btn-init-start').onclick = () => {
                const nick = $('init-nick').value.trim();
                if (!nick) { showModal("„Éã„ÉÉ„ÇØ„Éç„Éº„É†„ÇíÂÖ•Âäõ„Åó„Å¶„Åè„Å†„Åï„ÅÑ"); return; }
                state.nickname = nick; saveSettings(); state.screen = "title"; render();
            };
        }

        function renderTitle(el) {
            el.innerHTML = `
                <h1>English-Words-Master</h1>
                <div style="margin-top: 1rem;">
                    <button id="btn-start">„Çπ„Çø„Éº„Éà</button>
                    <button id="btn-ranking" class="secondary">Ë®òÈå≤„ÇíË¶ã„Çã</button>
                    <button id="btn-settings" class="secondary">Ë®≠ÂÆö</button>
                </div>
            `;
            el.querySelector('#btn-start').onclick = () => { state.screen = "grade"; render(); };
            el.querySelector('#btn-ranking').onclick = () => { state.screen = "ranking"; render(); };
            el.querySelector('#btn-settings').onclick = () => { state.screen = "settings"; render(); };
        }

        function renderGrade(el) {
            el.innerHTML = `
                <h1>Â≠¶Âπ¥ÈÅ∏Êäû</h1>
                <button data-grade="grade1">1Âπ¥</button>
                <button data-grade="grade2">2Âπ¥</button>
                <button data-grade="grade3">3Âπ¥</button>
                <button class="secondary" id="grade-back">Êàª„Çã</button>
            `;
            el.querySelectorAll("button[data-grade]").forEach(b => {
                b.onclick = () => {
                    state.grade = b.dataset.grade;
                    state.unit = getUnits()[0] || "Unit1";
                    state.screen = "select";
                    render();
                };
            });
            el.querySelector("#grade-back").onclick = () => {
                state.screen = "title";
                render();
            };
        }

        function renderSelect(el) {
            el.innerHTML = `
                <h1>„É¢„Éº„Éâ„Éª„É¶„Éã„ÉÉ„ÉàÈÅ∏Êäû</h1>
                <div class="select-group"><p class="select-label">„É¢„Éº„Éâ</p><div style="display: flex; gap: 10px;">
                    <button id="mode-typing" class="${state.mode === 'typing' ? '' : 'secondary'}">Typing</button>
                    <button id="mode-card" class="${state.mode === 'card' ? '' : 'secondary'}">Card</button>
                </div></div>
                <div class="select-group"><p class="select-label">„É¶„Éã„ÉÉ„Éà</p><div style="display: grid; grid-template-columns: 1fr 1fr; gap: 10px;">
                    ${getUnits().map(u => `<button class="unit-btn ${state.unit === u ? '' : 'secondary'}" data-unit="${u}">${u}</button>`).join('')}
                </div></div>
                <div style="margin-top: auto;">
                    <button id="btn-go" style="background: var(--correct); border-color: var(--correct);">„Ç≤„Éº„É†ÈñãÂßãÔºÅ</button>
                    <button id="btn-back" class="secondary">Êàª„Çã</button>
                </div>
            `;
            el.querySelector('#mode-typing').onclick = () => { state.mode = 'typing'; render(); };
            el.querySelector('#mode-card').onclick = () => { state.mode = 'card'; render(); };
            el.querySelectorAll('.unit-btn').forEach(b => { b.onclick = () => { state.unit = b.dataset.unit; render(); }; });
            el.querySelector('#btn-back').onclick = () => { state.screen = "title"; render(); };
            el.querySelector('#btn-go').onclick = () => { startCountdown(); };
        }

        function renderCountdown(el) {
            el.innerHTML = `
                <div class="countdown-number">${state.countdownValue}</div>
                <p style="margin-top: 20px; font-weight: bold; font-size: 1.2rem;">Ready...</p>
            `;
        }

        function renderGame(el) {
            el.innerHTML = `
                <div class="game-header"><div class="score-display">Score: ${state.score}</div><div class="timer">${state.timeLeft}</div></div>
                <div class="question-card"><div class="question-jp">${state.currentWord.jp}</div><div class="question-hint">Ëã±ÂçòË™û„ÇíÂÖ•Âäõ„Åó„Å¶„Åè„Å†„Åï„ÅÑ</div></div>
                <div class="input-area">
                    ${state.mode === 'typing' ? `<input type="text" class="typing-input" spellcheck="false" autocomplete="off" autofocus>` : `
                        <div class="card-area"><div class="answer-slots">
                            ${state.cardAnswer.map((item, i) => `<div class="char-card active-ans" data-idx="${i}">${item.char}</div>`).join('')}
                        </div><div class="choice-pool">
                            ${state.currentChoices.map((item) => `<div class="char-card choice-card ${item.used ? 'used' : ''}" data-id="${item.id}">${item.char}</div>`).join('')}
                        </div></div>
                    `}
                </div>
                <div style="margin-top: auto; padding-top: 20px; display: flex; gap: 10px;">
                    <button id="btn-skip" class="secondary" style="min-height: 40px; padding: 10px; flex: 1;">„Çπ„Ç≠„ÉÉ„Éó</button>
                    <button id="btn-quit" class="secondary" style="min-height: 40px; padding: 10px; flex: 1;">‰∏≠Êñ≠„Åô„Çã</button>
                </div>
            `;
            el.querySelector('#btn-skip').onclick = () => {
                if (state.currentWord) {
                    state.wrongWords.push({ jp: state.currentWord.jp, en: state.currentWord.en });
                    triggerFeedback(false);
                }
                pickQuestion();
            };
            el.querySelector('#btn-quit').onclick = () => {
                showModal("„Ç≤„Éº„É†„Çí‰∏≠Êñ≠„Åó„Åæ„Åô„ÅãÔºü", [{ text: "„ÅÑ„ÅÑ„Åà" }, { text: "„ÅØ„ÅÑ", onClick: () => { clearInterval(state.timerId); state.screen = "title"; render(); } }]);
            };
            if (state.mode === 'typing') {
                const input = el.querySelector('.typing-input');
                input.onkeydown = (e) => { if (e.key === 'Enter') handleAnswer(input.value.trim()); };
            } else {
                el.querySelectorAll('.choice-card').forEach(c => {
                    c.onclick = () => {
                        const id = parseInt(c.dataset.id); const item = state.currentChoices.find(choice => choice.id === id);
                        if (!item.used) {
                            item.used = true; state.cardAnswer.push(item);
                            if (state.cardAnswer.length === state.currentWord.en.length) setTimeout(() => handleAnswer(state.cardAnswer.map(i => i.char).join('')), 100);
                            else render();
                        }
                    };
                });
                el.querySelectorAll('.active-ans').forEach(s => {
                    s.onclick = () => { const idx = parseInt(s.dataset.idx); const removed = state.cardAnswer.splice(idx, 1)[0]; removed.used = false; render(); };
                });
            }
        }

        function renderResult(el) {
            el.innerHTML = `
                <h1>ÁµêÊûúÁô∫Ë°®</h1>
                <div class="question-card" style="padding: 20px; background: var(--card-bg); margin-bottom: 1rem;">
                    <div style="font-size: 1.2rem; color: var(--text-muted);">Total Score</div>
                    <div style="font-size: 3rem; font-weight: bold; color: var(--accent);">${state.score}</div>
                    <div style="margin-top: 10px; font-weight: bold;">Ê≠£Ëß£Êï∞: ${state.correctCount} Âïè</div>
                    <div style="font-size: 0.8rem; color: var(--text-muted); margin-top: 8px;">Player: ${state.nickname}</div>
                </div>
                
                <p class="select-label">ÈñìÈÅï„Åà„ÅüÂçòË™û (${state.wrongWords.length})</p>
                <div class="result-list">
                    ${state.wrongWords.length > 0 ? state.wrongWords.map(w => `
                        <div class="result-item">
                            <span style="flex: 1.5; font-size: 0.95rem;">${w.jp}</span>
                            <span style="flex: 2; font-weight: bold; color: var(--wrong); text-align: center;">${w.en}</span>
                            <button class="speak-btn" data-word="${w.en}" style="min-height: 35px; width: 45px; padding: 0; margin: 0; border-color: var(--text-muted); background: transparent; flex-shrink: 0; font-size: 1.2rem;">üîà</button>
                        </div>
                    `).join('') : '<p style="text-align:center; padding: 20px;">ÂÖ®ÂïèÊ≠£Ëß£ÔºÅÁ¥†Êô¥„Çâ„Åó„ÅÑÔºÅ</p>'}
                </div>
                <div style="margin-top: 1rem;">
                    <button id="btn-retry">„ÇÇ„ÅÜ‰∏ÄÂ∫¶ÊåëÊà¶</button>
                    <button id="btn-home" class="secondary">„Éà„ÉÉ„Éó„Å∏Êàª„Çã</button>
                </div>
            `;
            
            el.querySelectorAll('.speak-btn').forEach(btn => {
                btn.onclick = (e) => {
                    e.stopPropagation();
                    speakWord(btn.dataset.word);
                };
            });

            el.querySelector('#btn-retry').onclick = () => { state.screen = "select"; render(); };
            el.querySelector('#btn-home').onclick = () => { state.screen = "title"; render(); };
        }

        function renderRanking(el) {
            const totalHighScore = Object.values(state.userStats.unitBests).reduce((a, b) => a + b, 0);
            el.innerHTML = `
                <h1>ÂÄã‰∫∫Ë®òÈå≤</h1>
                <div class="my-stats-card">
                    <p style="font-weight:bold; margin-bottom:10px; border-bottom:1px solid #334155;">„ÅÇ„Å™„Åü„ÅÆ„Éè„Ç§„Çπ„Ç≥„Ç¢</p>
                    <div class="stat-row"><span>Á¥ØË®à„Éù„Ç§„É≥„Éà:</span> <span class="stat-val">${state.userStats.cumulativeTotal}</span></div>
                    <div class="stat-row"><span>Ëá™Â∑±„Éô„Çπ„ÉàÂêàË®à:</span> <span class="stat-val">${totalHighScore}</span></div>
                    <div style="margin-top:10px; font-size:0.8rem; color:var(--text-muted);">„É¶„Éã„ÉÉ„ÉàÂà•„Éô„Çπ„Éà„Çπ„Ç≥„Ç¢:</div>
                    <div style="display:grid; grid-template-columns: 1fr 1fr; gap:5px; margin-top:5px;">
                        ${getUnits().map(u => `
                            <div style="font-size:0.75rem; background:#0f172a; padding:4px; border-radius:4px;">
                                ${u}: <span style="color:var(--accent); font-weight:bold;">${state.userStats.unitBests[u] || 0}</span>
                            </div>
                        `).join('')}
                    </div>
                </div>
                <div style="margin-top: auto;"><button id="btn-rank-back" class="secondary">Êàª„Çã</button></div>
            `;
            el.querySelector('#btn-rank-back').onclick = () => { state.screen = "title"; render(); };
        }

        function renderSettings(el) {
            el.innerHTML = `
                <h1>Ë®≠ÂÆö</h1><div class="setting-item"><label>„Éã„ÉÉ„ÇØ„Éç„Éº„É†</label><input type="text" id="input-nick" value="${state.nickname}"></div>
                <div class="setting-item"><label>ÂäπÊûúÈü≥</label><button id="btn-toggle-sound" class="${state.soundOn ? '' : 'secondary'}">${state.soundOn ? 'ON' : 'OFF'}</button></div>
                <div class="setting-item" style="margin-top: 2rem;"><button id="btn-reset-rank" class="secondary" style="color: var(--wrong); border-color: var(--wrong);">„Éá„Éº„ÇøÊ∂àÂéª</button></div>
                <div style="margin-top: auto;"><button id="btn-save">‰øùÂ≠ò„Åó„Å¶Êàª„Çã</button></div>
            `;
            el.querySelector('#btn-toggle-sound').onclick = () => { state.soundOn = !state.soundOn; render(); };
            el.querySelector('#btn-reset-rank').onclick = () => {
                showModal("„ÅÇ„Å™„Åü„ÅÆÂÖ®„Å¶„ÅÆ„Éá„Éº„Çø„ÇíÂâäÈô§„Åó„Åæ„Åô„ÅãÔºü", [{ text: "„Ç≠„É£„É≥„Çª„É´" }, { text: "ÂâäÈô§„Åô„Çã", type: "danger", onClick: () => {
                    localStorage.removeItem('userStats');
                    state.userStats = { cumulativeTotal: 0, unitBests: {} };
                    showModal("„Éá„Éº„Çø„ÇíÂâäÈô§„Åó„Åæ„Åó„Åü„ÄÇ");
                }}]);
            };
            el.querySelector('#btn-save').onclick = () => {
                const nick = $('input-nick').value.trim(); if (!nick) { showModal("„Éã„ÉÉ„ÇØ„Éç„Éº„É†„ÇíÂÖ•Âäõ„Åó„Å¶„Åè„Å†„Åï„ÅÑ"); return; }
                state.nickname = nick; saveSettings(); state.screen = "title"; render();
            };
        }

        function shuffleArray(array) {
            const a = [...array];
            for (let i = a.length - 1; i > 0; i--) { const j = Math.floor(Math.random() * (i + 1)); [a[i], a[j]] = [a[j], a[i]]; }
            return a;
        }

        speechSynthesis.getVoices(); 

        function init() { if (state.nickname) state.screen = "title"; render(); }
        init();
        window.onbeforeunload = (e) => { if (state.screen === "game") return "ÁµÇ‰∫Ü„Åó„Åæ„Åô„ÅãÔºü"; };
    </script>
</body>
</html>
