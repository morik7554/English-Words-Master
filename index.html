<!DOCTYPE html>
<html lang="ja">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>Codex Word Master</title>
    <style>
        :root {
            --bg-color: #0f172a;
            --card-bg: #1e293b;
            --accent: #38bdf8;
            --correct: #22c55e;
            --wrong: #ef4444;
            --text: #f8fafc;
            --text-muted: #94a3b8;
        }

        * {
            box-sizing: border-box;
            margin: 0;
            padding: 0;
            -webkit-tap-highlight-color: transparent;
            user-select: none;
        }

        body {
            font-family: 'Helvetica Neue', Arial, sans-serif;
            background-color: var(--bg-color);
            color: var(--text);
            overflow: hidden;
            width: 100vw;
            height: 100vh;
            display: flex;
            justify-content: center;
        }

        #app {
            width: 100%;
            max-width: 500px;
            height: 100%;
            position: relative;
            display: flex;
            flex-direction: column;
            padding: 20px;
        }

        h1 { font-size: 1.8rem; text-align: center; margin-bottom: 1rem; color: var(--accent); }
        .screen { display: none; flex-direction: column; height: 100%; }
        .screen.active { display: flex; }
        .screen-fade { animation: fadeIn 0.3s ease-out; }
        @keyframes fadeIn { from { opacity: 0; transform: translateY(10px); } to { opacity: 1; transform: translateY(0); } }

        button {
            background-color: var(--card-bg);
            border: 2px solid var(--accent);
            color: var(--text);
            padding: 16px;
            border-radius: 12px;
            font-size: 1.1rem;
            font-weight: bold;
            cursor: pointer;
            transition: all 0.2s;
            margin-bottom: 12px;
            width: 100%;
            display: flex;
            justify-content: center;
            align-items: center;
            min-height: 60px;
        }
        button:active { transform: scale(0.98); background-color: var(--accent); color: var(--bg-color); }
        button.secondary { border-color: var(--text-muted); color: var(--text-muted); }

        .title-screen, .init-screen, .countdown-screen { justify-content: center; text-align: center; }
        .countdown-number { font-size: 8rem; font-weight: bold; color: var(--accent); animation: pulse 1s infinite; }
        @keyframes pulse { 0% { transform: scale(1); } 50% { transform: scale(1.1); } 100% { transform: scale(1); } }

        .select-group { margin-bottom: 2rem; }
        .select-label { font-size: 0.9rem; color: var(--text-muted); margin-bottom: 0.5rem; }

        .game-header { display: flex; justify-content: space-between; align-items: center; margin-bottom: 1rem; }
        .timer { font-size: 1.5rem; font-weight: bold; font-variant-numeric: tabular-nums; }
        .timer.low { color: var(--wrong); }
        .score-display { font-size: 1.2rem; color: var(--accent); }

        .question-card {
            background: var(--card-bg);
            padding: 40px 20px;
            border-radius: 20px;
            text-align: center;
            margin-bottom: 2rem;
            box-shadow: 0 10px 25px -5px rgba(0,0,0,0.3);
        }
        .question-jp { font-size: 2rem; font-weight: bold; margin-bottom: 0.5rem; }
        .question-hint { color: var(--text-muted); font-size: 1rem; }

        .typing-input {
            background: var(--card-bg);
            border: 2px solid var(--accent);
            border-radius: 12px;
            padding: 16px;
            font-size: 1.5rem;
            color: var(--text);
            text-align: center;
            outline: none;
            width: 100%;
        }

        .card-area { display: flex; flex-direction: column; gap: 1rem; }
        .answer-slots { display: flex; flex-wrap: wrap; justify-content: center; gap: 8px; min-height: 50px; border-bottom: 2px solid var(--accent); padding-bottom: 8px; }
        .choice-pool { display: flex; flex-wrap: wrap; justify-content: center; gap: 8px; margin-top: 1rem; }
        .char-card {
            background: var(--accent);
            color: var(--bg-color);
            width: 45px;
            height: 45px;
            display: flex;
            justify-content: center;
            align-items: center;
            border-radius: 8px;
            font-size: 1.2rem;
            font-weight: bold;
            box-shadow: 0 4px 0 #075985;
        }
        .char-card.used { opacity: 0.2; pointer-events: none; background: #475569; box-shadow: none; transform: translateY(2px); }

        .feedback {
            position: fixed;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            font-size: 8rem;
            pointer-events: none;
            z-index: 100;
            opacity: 0;
        }
        .feedback.show { animation: popFeedback 0.4s ease-out; }
        @keyframes popFeedback { 
            0% { opacity: 0; transform: translate(-50%, -50%) scale(0.5); }
            50% { opacity: 1; transform: translate(-50%, -50%) scale(1.2); }
            100% { opacity: 0; transform: translate(-50%, -50%) scale(1); }
        }

        .result-list { flex-grow: 1; overflow-y: auto; margin: 1rem 0; padding-right: 5px; }
        .result-item { display: flex; justify-content: space-between; padding: 10px; border-bottom: 1px solid #334155; }

        .setting-item { margin-bottom: 1.5rem; }
        .setting-item label { display: block; margin-bottom: 0.5rem; color: var(--text-muted); }
        input[type="text"] { width: 100%; padding: 12px; border-radius: 8px; border: 1px solid var(--text-muted); background: var(--bg-color); color: var(--text); font-size: 1.1rem; outline: none; }
        input[type="text"]:focus { border-color: var(--accent); }

        .modal-overlay {
            position: fixed;
            top: 0; left: 0; width: 100%; height: 100%;
            background: rgba(0,0,0,0.8);
            display: none;
            justify-content: center;
            align-items: center;
            z-index: 1000;
        }
        .modal {
            background: var(--card-bg);
            padding: 24px;
            border-radius: 16px;
            width: 80%;
            max-width: 320px;
            text-align: center;
        }
    </style>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/html2canvas/1.4.1/html2canvas.min.js"></script>
</head>
<body>

    <div id="app"></div>
    <div id="feedback" class="feedback"></div>
    <div id="modal-overlay" class="modal-overlay">
        <div class="modal">
            <p id="modal-text" style="margin-bottom: 20px; line-height: 1.5;"></p>
            <div id="modal-buttons" style="display: flex; gap: 10px;"></div>
        </div>
    </div>

    <script type="module">
        import { initializeApp } from 'https://www.gstatic.com/firebasejs/11.6.1/firebase-app.js';
        import { getAuth, signInAnonymously, onAuthStateChanged } from 'https://www.gstatic.com/firebasejs/11.6.1/firebase-auth.js';
        import { getFirestore, doc, getDoc, setDoc } from 'https://www.gstatic.com/firebasejs/11.6.1/firebase-firestore.js';

        const firebaseConfig = JSON.parse(__firebase_config);
        const app = initializeApp(firebaseConfig);
        const auth = getAuth(app);
        const db = getFirestore(app);
        const appId = typeof __app_id !== 'undefined' ? __app_id : 'default-app-id';

        const WORDS = [
            { jp: "りんご", en: "apple", unit: "UNIT1" }, { jp: "犬", en: "dog", unit: "UNIT1" },
            { jp: "猫", en: "cat", unit: "UNIT1" }, { jp: "本", en: "book", unit: "UNIT1" },
            { jp: "机", en: "desk", unit: "UNIT1" }, { jp: "学校", en: "school", unit: "UNIT2" },
            { jp: "先生", en: "teacher", unit: "UNIT2" }, { jp: "生徒", en: "student", unit: "UNIT2" },
            { jp: "教室", en: "classroom", unit: "UNIT2" }, { jp: "友達", en: "friend", unit: "UNIT2" },
            { jp: "水", en: "water", unit: "UNIT3" }, { jp: "オレンジ", en: "orange", unit: "UNIT3" },
            { jp: "ペン", en: "pen", unit: "UNIT3" }, { jp: "ノート", en: "notebook", unit: "UNIT3" },
            { jp: "鞄", en: "bag", unit: "UNIT3" }
        ];

        const state = {
            screen: "init",
            lastRenderedScreen: null,
            mode: "typing",
            unit: "UNIT1",
            timeLeft: 40,
            score: 0,
            correctCount: 0,
            wrongWords: [],
            currentWord: null,
            lastCorrectEn: null,
            nickname: "",
            soundOn: true,
            timerId: null,
            questionStartTime: 0,
            cardAnswer: [],
            currentChoices: [],
            user: null,
            countdownValue: 3
        };

        const UNITS = [...new Set(WORDS.map(w => w.unit))];
        const $ = (id) => document.getElementById(id);

        // --- Core Functions ---

        async function saveSettings() {
            if (!state.user) return;
            const userRef = doc(db, 'artifacts', appId, 'users', state.user.uid, 'profile', 'settings');
            await setDoc(userRef, {
                nickname: state.nickname,
                soundOn: state.soundOn
            }, { merge: true });
        }

        function showModal(text, buttons = []) {
            const overlay = $('modal-overlay');
            const txt = $('modal-text');
            const btns = $('modal-buttons');
            txt.innerText = text;
            btns.innerHTML = '';
            if (buttons.length === 0) buttons = [{ text: 'OK', onClick: () => overlay.style.display = 'none' }];
            buttons.forEach(b => {
                const btn = document.createElement('button');
                btn.innerText = b.text;
                btn.className = b.type === 'danger' ? 'secondary' : '';
                btn.onclick = () => { overlay.style.display = 'none'; if (b.onClick) b.onClick(); };
                btns.appendChild(btn);
            });
            overlay.style.display = 'flex';
        }

        function playSound(isCorrect) {
            if (!state.soundOn) return;
            const ctx = new (window.AudioContext || window.webkitAudioContext)();
            const osc = ctx.createOscillator();
            const gain = ctx.createGain();
            osc.connect(gain); gain.connect(ctx.destination);
            if (isCorrect) {
                osc.type = 'sine'; osc.frequency.setValueAtTime(880, ctx.currentTime);
                osc.frequency.exponentialRampToValueAtTime(1320, ctx.currentTime + 0.1);
            } else {
                osc.type = 'square'; osc.frequency.setValueAtTime(220, ctx.currentTime);
                osc.frequency.linearRampToValueAtTime(110, ctx.currentTime + 0.2);
            }
            gain.gain.setValueAtTime(0.1, ctx.currentTime);
            gain.gain.exponentialRampToValueAtTime(0.01, ctx.currentTime + 0.2);
            osc.start(); osc.stop(ctx.currentTime + 0.2);
        }

        function triggerFeedback(isCorrect) {
            const el = $('feedback');
            el.innerText = isCorrect ? '◯' : '×';
            el.style.color = isCorrect ? 'var(--correct)' : 'var(--wrong)';
            el.classList.remove('show'); void el.offsetWidth; el.classList.add('show');
            playSound(isCorrect);
        }

        function calcScore(elapsedMs) {
            if (elapsedMs <= 1000) return 100;
            return Math.max(0, 100 - Math.floor((elapsedMs - 1000) / 750) * 4);
        }

        function pickQuestion() {
            const pool = WORDS.filter(w => w.unit === state.unit);
            let candidates = pool.filter(w => w.en !== state.lastCorrectEn);
            if (candidates.length === 0) candidates = pool;
            const next = candidates[Math.floor(Math.random() * candidates.length)];
            state.currentWord = next;
            state.questionStartTime = Date.now();
            state.cardAnswer = [];
            if (state.mode === 'card') {
                state.currentChoices = shuffleArray(next.en.split('')).map((char, index) => ({ id: index, char, used: false }));
            }
            render();
            if (state.mode === 'typing') {
                setTimeout(() => { const input = document.querySelector('.typing-input'); if (input) input.focus(); }, 50);
            }
        }

        function handleAnswer(answer) {
            const elapsed = Date.now() - state.questionStartTime;
            const isCorrect = answer === state.currentWord.en;
            if (isCorrect) {
                state.score += calcScore(elapsed); state.correctCount++;
                state.lastCorrectEn = state.currentWord.en;
            } else {
                state.wrongWords.push({ jp: state.currentWord.jp, en: state.currentWord.en });
            }
            triggerFeedback(isCorrect); pickQuestion();
        }

        function startCountdown() {
            state.screen = "countdown";
            state.countdownValue = 3;
            render();
            
            const interval = setInterval(() => {
                state.countdownValue--;
                if (state.countdownValue <= 0) {
                    clearInterval(interval);
                    state.screen = "game";
                    state.score = 0; state.correctCount = 0; state.wrongWords = []; state.lastCorrectEn = null;
                    startTimer(); pickQuestion();
                } else {
                    render();
                }
            }, 1000);
        }

        function startTimer() {
            state.timeLeft = 40;
            state.timerId = setInterval(() => {
                state.timeLeft--;
                const timerEl = document.querySelector('.timer');
                if (timerEl) {
                    timerEl.innerText = state.timeLeft;
                    if (state.timeLeft <= 10) timerEl.classList.add('low');
                }
                if (state.timeLeft <= 0) endGame();
            }, 1000);
        }

        function endGame() {
            clearInterval(state.timerId);
            state.screen = "result";
            render();
        }

        // --- Render Functions ---

        function render() {
            const container = $('app');
            const isNewScreen = state.screen !== state.lastRenderedScreen;
            container.innerHTML = '';
            const screenDiv = document.createElement('div');
            screenDiv.className = `screen active ${state.screen}-screen ${isNewScreen ? 'screen-fade' : ''}`;
            state.lastRenderedScreen = state.screen;

            switch (state.screen) {
                case "init": renderInit(screenDiv); break;
                case "title": renderTitle(screenDiv); break;
                case "select": renderSelect(screenDiv); break;
                case "countdown": renderCountdown(screenDiv); break;
                case "game": renderGame(screenDiv); break;
                case "result": renderResult(screenDiv); break;
                case "settings": renderSettings(screenDiv); break;
            }
            container.appendChild(screenDiv);
        }

        function renderInit(el) {
            el.innerHTML = `
                <h1>Welcome</h1>
                <div class="setting-item">
                    <label>ニックネームを入力してください</label>
                    <input type="text" id="init-nick" value="${state.nickname}" placeholder="名前を入力..." autofocus>
                </div>
                <button id="btn-init-start">はじめる</button>
            `;
            el.querySelector('#btn-init-start').onclick = async () => {
                const nick = $('init-nick').value.trim();
                if (!nick) { showModal("ニックネームを入力してください"); return; }
                state.nickname = nick; 
                await saveSettings();
                state.screen = "title"; render();
            };
        }

        function renderTitle(el) {
            el.innerHTML = `
                <h1>Codex<br>Word Master</h1>
                <div style="margin-top: 2rem;">
                    <button id="btn-start">スタート</button>
                    <button id="btn-settings" class="secondary">設定</button>
                </div>
            `;
            el.querySelector('#btn-start').onclick = () => { state.screen = "select"; render(); };
            el.querySelector('#btn-settings').onclick = () => { state.screen = "settings"; render(); };
        }

        function renderSelect(el) {
            el.innerHTML = `
                <h1>モード・ユニット選択</h1>
                <div class="select-group"><p class="select-label">モード</p><div style="display: flex; gap: 10px;">
                    <button id="mode-typing" class="${state.mode === 'typing' ? '' : 'secondary'}">Typing</button>
                    <button id="mode-card" class="${state.mode === 'card' ? '' : 'secondary'}">Card</button>
                </div></div>
                <div class="select-group"><p class="select-label">ユニット</p><div style="display: grid; grid-template-columns: 1fr 1fr; gap: 10px;">
                    ${UNITS.map(u => `<button class="unit-btn ${state.unit === u ? '' : 'secondary'}" data-unit="${u}">${u}</button>`).join('')}
                </div></div>
                <div style="margin-top: auto;">
                    <button id="btn-go" style="background: var(--correct); border-color: var(--correct);">ゲーム開始！</button>
                    <button id="btn-back" class="secondary">戻る</button>
                </div>
            `;
            el.querySelector('#mode-typing').onclick = () => { state.mode = 'typing'; render(); };
            el.querySelector('#mode-card').onclick = () => { state.mode = 'card'; render(); };
            el.querySelectorAll('.unit-btn').forEach(b => { b.onclick = () => { state.unit = b.dataset.unit; render(); }; });
            el.querySelector('#btn-back').onclick = () => { state.screen = "title"; render(); };
            el.querySelector('#btn-go').onclick = () => {
                startCountdown();
            };
        }

        function renderCountdown(el) {
            el.innerHTML = `
                <div class="countdown-number">${state.countdownValue}</div>
                <p style="margin-top: 20px; font-weight: bold; font-size: 1.2rem;">Ready...</p>
            `;
        }

        function renderGame(el) {
            el.innerHTML = `
                <div class="game-header"><div class="score-display">Score: ${state.score}</div><div class="timer">${state.timeLeft}</div></div>
                <div class="question-card"><div class="question-jp">${state.currentWord.jp}</div><div class="question-hint">英単語を入力してください</div></div>
                <div class="input-area">
                    ${state.mode === 'typing' ? `<input type="text" class="typing-input" spellcheck="false" autocomplete="off" autofocus>` : `
                        <div class="card-area"><div class="answer-slots">
                            ${state.cardAnswer.map((item, i) => `<div class="char-card active-ans" data-idx="${i}">${item.char}</div>`).join('')}
                        </div><div class="choice-pool">
                            ${state.currentChoices.map((item) => `<div class="char-card choice-card ${item.used ? 'used' : ''}" data-id="${item.id}">${item.char}</div>`).join('')}
                        </div></div>
                    `}
                </div>
                <div style="margin-top: auto; padding-top: 20px;"><button id="btn-quit" class="secondary" style="min-height: 40px; padding: 10px;">中断する</button></div>
            `;
            el.querySelector('#btn-quit').onclick = () => {
                showModal("ゲームを中断しますか？", [{ text: "いいえ" }, { text: "はい", onClick: () => { clearInterval(state.timerId); state.screen = "title"; render(); } }]);
            };
            if (state.mode === 'typing') {
                const input = el.querySelector('.typing-input');
                input.onkeydown = (e) => { if (e.key === 'Enter') handleAnswer(input.value.trim()); };
            } else {
                el.querySelectorAll('.choice-card').forEach(c => {
                    c.onclick = () => {
                        const id = parseInt(c.dataset.id); const item = state.currentChoices.find(choice => choice.id === id);
                        if (!item.used) {
                            item.used = true; state.cardAnswer.push(item);
                            if (state.cardAnswer.length === state.currentWord.en.length) setTimeout(() => handleAnswer(state.cardAnswer.map(i => i.char).join('')), 100);
                            else render();
                        }
                    };
                });
                el.querySelectorAll('.active-ans').forEach(s => {
                    s.onclick = () => { const idx = parseInt(s.dataset.idx); const removed = state.cardAnswer.splice(idx, 1)[0]; removed.used = false; render(); };
                });
            }
        }

        function renderResult(el) {
            el.innerHTML = `
                <h1>結果発表</h1>
                <div id="capture-area" class="question-card" style="padding: 20px; background: var(--card-bg);">
                    <div style="font-size: 1.2rem; color: var(--text-muted);">Total Score</div>
                    <div style="font-size: 3rem; font-weight: bold; color: var(--accent);">${state.score}</div>
                    <div style="margin-top: 10px; font-weight: bold;">正解数: ${state.correctCount} 問</div>
                    <div style="font-size: 0.8rem; color: var(--text-muted); margin-top: 8px;">Player: ${state.nickname}</div>
                </div>
                <button id="btn-copy-img" style="min-height: 50px; font-size: 1rem; background: var(--correct); border-color: var(--correct);">結果を画像としてコピー</button>
                
                <p class="select-label">間違えた単語 (${state.wrongWords.length})</p>
                <div class="result-list">
                    ${state.wrongWords.length > 0 ? state.wrongWords.map(w => `<div class="result-item"><span style="font-weight: bold; color: var(--wrong);">${w.en}</span><span>${w.jp}</span></div>`).join('') : '<p style="text-align:center; padding: 20px;">全問正解！</p>'}
                </div>
                <div style="margin-top: auto;">
                    <button id="btn-retry">もう一度挑戦</button>
                    <button id="btn-home" class="secondary">トップへ戻る</button>
                </div>
            `;
            
            el.querySelector('#btn-copy-img').onclick = async () => {
                const target = document.getElementById('capture-area');
                try {
                    const canvas = await html2canvas(target, {
                        backgroundColor: '#1e293b',
                        scale: 2
                    });
                    
                    canvas.toBlob(async (blob) => {
                        try {
                            const data = [new ClipboardItem({ [blob.type]: blob })];
                            await navigator.clipboard.write(data);
                            showModal("結果画像をクリップボードにコピーしました！\nSNSなどにそのまま貼り付けられます。");
                        } catch (err) {
                            showModal("コピーに失敗しました。ブラウザの制限により、画像コピーが許可されていない可能性があります。");
                        }
                    });
                } catch (err) {
                    showModal("画像の作成に失敗しました。");
                }
            };

            el.querySelector('#btn-retry').onclick = () => { state.screen = "select"; render(); };
            el.querySelector('#btn-home').onclick = () => { state.screen = "title"; render(); };
        }

        function renderSettings(el) {
            el.innerHTML = `
                <h1>設定</h1><div class="setting-item"><label>ニックネーム</label><input type="text" id="input-nick" value="${state.nickname}"></div>
                <div class="setting-item"><label>効果音</label><button id="btn-toggle-sound" class="${state.soundOn ? '' : 'secondary'}">${state.soundOn ? 'ON' : 'OFF'}</button></div>
                <div style="margin-top: auto;"><button id="btn-save">保存して戻る</button></div>
            `;
            el.querySelector('#btn-toggle-sound').onclick = () => { state.soundOn = !state.soundOn; render(); };
            el.querySelector('#btn-save').onclick = async () => {
                const nick = $('input-nick').value.trim(); if (!nick) { showModal("ニックネームを入力してください"); return; }
                state.nickname = nick; await saveSettings(); state.screen = "title"; render();
            };
        }

        function shuffleArray(array) {
            const a = [...array];
            for (let i = a.length - 1; i > 0; i--) { const j = Math.floor(Math.random() * (i + 1)); [a[i], a[j]] = [a[j], a[i]]; }
            return a;
        }

        // --- Init ---

        async function init() {
            onAuthStateChanged(auth, async (user) => {
                if (user) {
                    state.user = user;
                    const userRef = doc(db, 'artifacts', appId, 'users', user.uid, 'profile', 'settings');
                    const snap = await getDoc(userRef);
                    if (snap.exists()) {
                        state.nickname = snap.data().nickname || "";
                        state.soundOn = snap.data().soundOn !== false;
                    }
                    if (state.nickname) state.screen = "title";
                    render();
                } else {
                    signInAnonymously(auth);
                }
            });
        }

        init();
        window.onbeforeunload = (e) => { if (state.screen === "game") return "終了しますか？"; };
    </script>
</body>
</html>
